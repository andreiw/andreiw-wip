From 1f1d268926c95abd0b080332cabf2083c925f3af Mon Sep 17 00:00:00 2001
From: Andrei Warkentin <andrey.warkentin@gmail.com>
Date: Tue, 27 Sep 2011 00:34:36 -0400
Subject: [PATCH 6/8] FDBG: Allow platform-specific command execution.

Allows platforms to define their own FIQ debugger commands.

Signed-off-by: Andrei Warkentin <andrey.warkentin@gmail.com>
---
 arch/arm/include/asm/fiq_debugger.h |   27 +++++++++++++++++++++++++++
 1 files changed, 27 insertions(+), 0 deletions(-)

diff --git a/arch/arm/include/asm/fiq_debugger.h b/arch/arm/include/asm/fiq_debugger.h
index 4698566..c14249e 100644
--- a/arch/arm/include/asm/fiq_debugger.h
+++ b/arch/arm/include/asm/fiq_debugger.h
@@ -25,6 +25,11 @@
 #define FIQ_DEBUGGER_NO_CHAR NO_POLL_CHAR
 #define FIQ_DEBUGGER_BREAK 0x00ff0100
 
+struct fiq_debugger_ctxt {
+  int (*printf)(void *cookie, const char *fmt, ...);
+  void *cookie;
+};
+
 struct fiq_debugger_pdata {
 	int (*uart_init)(struct platform_device *pdev);
 	void (*uart_free)(struct platform_device *pdev);
@@ -40,6 +45,28 @@ struct fiq_debugger_pdata {
 	void (*force_irq)(struct platform_device *pdev, unsigned int irq);
 	void (*force_irq_ack)(struct platform_device *pdev, unsigned int irq);
 	struct clk *(*uart_clk)(struct platform_device *pdev);
+
+	/*
+	 * platform_cmds() is called from IRQ context and should
+	 * use the ctxt.printf to write output (do NOT call
+	 * printk, do operations not safe from IRQ context, etc).
+	 *
+	 * ctxt.printf will return -1 if there is not enough
+	 * buffer space or if you are being aborted.  In this case
+	 * you must return as soon as possible.
+	 *
+	 * Return non-zero if more data is available -- if buffer
+	 * space ran and you had to stop, but could print more,
+	 * for example.
+	 *
+	 * Additional calls where cmd is "more" will be made if
+	 * the additional data is desired.
+	 *
+	 */
+
+	int (*platform_cmds)(struct platform_device *pdev,
+			     struct fiq_debugger_ctxt *ctxt,
+			     char *cmd);
 };
 
 #endif
-- 
1.7.6.1

