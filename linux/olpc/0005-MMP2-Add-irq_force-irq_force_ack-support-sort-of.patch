From 0f6657560eddbb3839a84d865ebbaffd996bc573 Mon Sep 17 00:00:00 2001
From: Andrei Warkentin <andrey.warkentin@gmail.com>
Date: Mon, 26 Sep 2011 22:51:48 -0400
Subject: [PATCH 5/7] MMP2: Add irq_force/irq_force_ack support (sort of).

Leverages MMP2 IPC support that raises/acks IRQ 56.

Signed-off-by: Andrei Warkentin <andrey.warkentin@gmail.com>
---
 arch/arm/mach-mmp/include/mach/irqs.h |    1 +
 arch/arm/mach-mmp/mmp2_fiq_debugger.c |   17 +++++++++++++++++
 arch/arm/mach-mmp/olpc-xo-1-75.c      |    2 +-
 3 files changed, 19 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-mmp/include/mach/irqs.h b/arch/arm/mach-mmp/include/mach/irqs.h
index dd4545d..68c66c3 100644
--- a/arch/arm/mach-mmp/include/mach/irqs.h
+++ b/arch/arm/mach-mmp/include/mach/irqs.h
@@ -168,6 +168,7 @@
 #define IRQ_MMP2_MMC3			53
 #define IRQ_MMP2_MMC4			54
 #define IRQ_MMP2_MIPI_HSI		55
+#define IRQ_MMP2_SELF			56
 #define IRQ_MMP2_MSP			58
 #define IRQ_MMP2_MIPI_SLIM_DMA		59
 #define IRQ_MMP2_PJ4_FREQ_CHG		60
diff --git a/arch/arm/mach-mmp/mmp2_fiq_debugger.c b/arch/arm/mach-mmp/mmp2_fiq_debugger.c
index 06de7d9..4f65ee4 100644
--- a/arch/arm/mach-mmp/mmp2_fiq_debugger.c
+++ b/arch/arm/mach-mmp/mmp2_fiq_debugger.c
@@ -22,6 +22,7 @@
 #include <linux/serial_reg.h>
 #include <asm/fiq_debugger.h>
 #include <mach/mmp2.h>
+#include <mach/addr-map.h>
 
 struct mmp2_fiq_debugger {
 	struct fiq_debugger_pdata pdata;
@@ -126,6 +127,20 @@ static void debug_fiq_enable(struct platform_device *pdev,
 		icu_fiq_disable(irq);
 }
 
+static void debug_force_irq(struct platform_device *pdev,
+                            unsigned int irq)
+{
+	BUG_ON(irq != 56);
+	writel(0x400, APB_VIRT_BASE + 0x1d008);
+}
+
+static void debug_force_irq_ack(struct platform_device *pdev,
+                                unsigned int irq)
+{
+	BUG_ON(irq != 56);
+	writel(0x400, APB_VIRT_BASE + 0x1d40c);
+}
+
 static int mmp2_fiq_debugger_id;
 
 int __init mmp2_fiq_debug_init(unsigned int base, struct clk *clk,
@@ -148,6 +163,8 @@ int __init mmp2_fiq_debug_init(unsigned int base, struct clk *clk,
 	d->pdata.uart_flush = debug_flush;
 	d->pdata.uart_clk = debug_clk;
 	d->pdata.fiq_enable = debug_fiq_enable;
+	d->pdata.force_irq = debug_force_irq;
+	d->pdata.force_irq_ack = debug_force_irq_ack;
 
 	d->clk = clk;
 	d->base = ioremap(base, PAGE_SIZE);
diff --git a/arch/arm/mach-mmp/olpc-xo-1-75.c b/arch/arm/mach-mmp/olpc-xo-1-75.c
index e60f93a..69a7f22 100644
--- a/arch/arm/mach-mmp/olpc-xo-1-75.c
+++ b/arch/arm/mach-mmp/olpc-xo-1-75.c
@@ -541,7 +541,7 @@ static void __init olpc_xo_1_75_init(void)
 	 */
 	debug_clk = clk_get_sys("pxa2xx-uart.3", NULL);
 	if (!mmp2_fiq_debug_init(0xd4018000, debug_clk, IRQ_MMP2_UART3,
-                                 IRQ_MMP2_UART3, -1)) {
+                                 IRQ_MMP2_SELF, -1)) {
           clk_put(debug_clk);
           mmp2_add_uart(3);  // ttyS2: normal console/debug
 	}
-- 
1.7.6.1

