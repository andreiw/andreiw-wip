#
# Makefile
#
# Leendert van Doorn, leendert@watson.ibm.com
# Copyright (c) 2005, International Business Machines Corporation.
#
# This program is free software; you can redistribute it and/or modify it
# under the terms and conditions of the GNU General Public License,
# version 2, as published by the Free Software Foundation.
#
# This program is distributed in the hope it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
# more details.
#
# You should have received a copy of the GNU General Public License along with
# this program; if not, write to the Free Software Foundation, Inc., 59 Temple
# Place - Suite 330, Boston, MA 02111-1307 USA.
#

XEN_ROOT = $(CURDIR)/../../..
include $(XEN_ROOT)/tools/firmware/Rules.mk

SUBDIRS := acpi

# The HVM loader is started in 32-bit mode at the address below:
LOADADDR = 0x100000

CFLAGS += $(CFLAGS_xeninclude)

OBJS  = hvmloader.o mp_tables.o util.o smbios.o 
OBJS += 32bitbios_support.o smp.o cacheattr.o xenbus.o
OBJS += e820.o
ifeq ($(debug),y)
OBJS += tests.o
endif

CIRRUSVGA_DEBUG ?= n

ROMBIOS_DIR := ../rombios
ifneq ($(ROMBIOS_DIR),)
OBJS += rombios.o
ROMBIOS_ROM := $(ROMBIOS_DIR)/BIOS-bochs-latest
endif
OVMF_DIR :=  ../ovmf
OVMF32_ROM := $(OVMF_DIR)/ovmf32.bin
OVMF64_ROM := $(OVMF_DIR)/ovmf64.bin
OVMF32_VGA_ROM := $(OVMF_DIR)/ovmfvga32.bin
OVMF64_VGA_ROM := $(OVMF_DIR)/ovmfvga64.bin

ifneq ($(OVMF32_ROM),)
OBJS += ovmf.o
endif

ifneq ($(OVMF64_ROM),)
OBJS += ovmf.o
endif

STDVGA_ROM    := ../vgabios/VGABIOS-lgpl-latest.bin
ifeq ($(CIRRUSVGA_DEBUG),y)
CIRRUSVGA_ROM := ../vgabios/VGABIOS-lgpl-latest.cirrus.debug.bin
else
CIRRUSVGA_ROM := ../vgabios/VGABIOS-lgpl-latest.cirrus.bin
endif

.PHONY: all
all: subdirs-all
	$(MAKE) hvmloader

hvmloader.o: roms.inc
smbios.o: CFLAGS += -D__SMBIOS_DATE__="\"$(shell date +%m/%d/%Y)\""

hvmloader: $(OBJS) acpi/acpi.a
	$(LD) $(LDFLAGS_DIRECT) -N -Ttext $(LOADADDR) -o hvmloader.tmp $^
	$(OBJCOPY) hvmloader.tmp hvmloader
	rm -f hvmloader.tmp

roms.inc: $(ROMBIOS_ROM) $(STDVGA_ROM) $(CIRRUSVGA_ROM) $(OVMF32_ROM) $(OVMF64_ROM) $(OVMF32_VGA_ROM) $(OVMF64_VGA_ROM) ../etherboot/eb-roms.h
	echo "/* Autogenerated file. DO NOT EDIT */" > roms.inc

ifneq ($(OVMF32_ROM),)
	echo "#ifdef ROM_INCLUDE_OVMF32" >> roms.inc
	sh ./mkhex ovmf32 $(OVMF32_ROM) >> roms.inc
	echo "#endif" >> roms.inc	
endif 

ifneq ($(OVMF64_ROM),)
	echo "#ifdef ROM_INCLUDE_OVMF64" >> roms.inc
	sh ./mkhex ovmf64 $(OVMF64_ROM) >> roms.inc
	echo "#endif" >> roms.inc	
endif 

ifneq ($(OVMF32_VGA_ROM),)
	echo "#ifdef ROM_INCLUDE_OVMF32_VGA" >> roms.inc
	sh ./mkhex ovmf32vga $(OVMF32_VGA_ROM) >> roms.inc
	echo "#endif" >> roms.inc	
endif 

ifneq ($(OVMF64_VGA_ROM),)
	echo "#ifdef ROM_INCLUDE_OVMF64_VGA" >> roms.inc
	sh ./mkhex ovmf64vga $(OVMF64_VGA_ROM) >> roms.inc
	echo "#endif" >> roms.inc	
endif 

ifneq ($(ROMBIOS_ROM),)
	echo "#ifdef ROM_INCLUDE_ROMBIOS" >> roms.inc
	sh ./mkhex rombios $(ROMBIOS_ROM) >> roms.inc
	echo "#endif" >> roms.inc
endif

ifneq ($(STDVGA_ROM),)
	echo "#ifdef ROM_INCLUDE_VGABIOS" >> roms.inc
	sh ./mkhex vgabios_stdvga $(STDVGA_ROM) >> roms.inc
	echo "#endif" >> roms.inc
endif
ifneq ($(CIRRUSVGA_ROM),)
	echo "#ifdef ROM_INCLUDE_VGABIOS" >> roms.inc
	sh ./mkhex vgabios_cirrusvga $(CIRRUSVGA_ROM) >> roms.inc
	echo "#endif" >> roms.inc
endif

	echo "#ifdef ROM_INCLUDE_ETHERBOOT" >> roms.inc
	cat ../etherboot/eb-roms.h >> roms.inc
	echo "#endif" >> roms.inc

.PHONY: clean
clean: subdirs-clean
	rm -f roms.inc acpi.h
	rm -f hvmloader hvmloader.tmp *.o $(DEPS)

-include $(DEPS)
